<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Driver Drowsiness — Dashboard</title>

  <!-- Google Font -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.umd.min.js"></script>

  <style>
    :root{
      --bg:#0f1724; --card:#0b1220; --muted:#94a3b8; --accent:#06b6d4; --glass: rgba(255,255,255,0.03);
      --chip:#071022;
      font-family: "Inter", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }
    html,body{height:100%;margin:0;background:linear-gradient(180deg,#071226 0%, #081629 100%);color:#e6eef6}
    .container{max-width:1100px;margin:28px auto;padding:20px;}
    header{display:flex;align-items:center;justify-content:space-between;gap:16px;margin-bottom:18px}
    h1{font-size:20px;margin:0;font-weight:700;letter-spacing:0.2px}
    .subtitle{color:var(--muted);font-size:13px}
    .top-controls{display:flex;gap:12px;align-items:center}
    .btn{background:var(--accent);color:#02202a;padding:8px 12px;border-radius:8px;border:none;cursor:pointer;font-weight:600;box-shadow:0 6px 18px rgba(6,182,212,0.12)}
    .btn.secondary{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted);box-shadow:none}
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:16px}
    .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border-radius:12px;padding:16px;box-shadow:0 6px 30px rgba(2,6,23,0.6);border:1px solid rgba(255,255,255,0.03)}
    .stat{grid-column:span 3;padding:18px;display:flex;flex-direction:column;gap:8px}
    .stat .label{font-size:12px;color:var(--muted)}
    .stat .value{font-size:22px;font-weight:700}
    .chart-card{grid-column:span 9;padding:14px;display:flex;flex-direction:column;height:380px}
    .right-panel{grid-column:span 3;padding:12px;display:flex;flex-direction:column;gap:12px;height:380px}
    .chart-wrap{flex:1;display:flex;align-items:center;justify-content:center}
    .small{font-size:13px;color:var(--muted)}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px;text-align:left;font-size:13px;color:#dbe7f2}
    th{font-size:12px;color:var(--muted);font-weight:600}
    tbody tr{border-top:1px solid rgba(255,255,255,0.02)}
    .placeholder{color:var(--muted);text-align:center;padding:30px}
    .badge{display:inline-block;background:var(--chip);padding:6px 8px;border-radius:999px;font-weight:600;font-size:12px}
    /* responsive */
    @media (max-width:980px){
      .chart-card{grid-column:span 12;height:420px}
      .right-panel{grid-column:span 12;height:auto}
      .stat{grid-column:span 6}
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div>
        <h1>Chaukas — Drowsiness Dashboard</h1>
        <div class="subtitle">Live summary of driver alerts • updates automatically</div>
      </div>

      <div class="top-controls">
        <a class="btn secondary" href="/">← Back to Application</a>
        <button id="refreshBtn" class="btn">Refresh now</button>
      </div>
    </header>

    <div class="grid" style="margin-bottom:16px">
      <div class="card stat">
        <div class="label">Sleep Alerts</div>
        <div id="sleepCount" class="value">0</div>
        <div class="small">Eyes closed / drowsiness events detected</div>
      </div>

      <div class="card stat">
        <div class="label">Yawns</div>
        <div id="yawnCount" class="value">0</div>
        <div class="small">Yawn events detected</div>
      </div>

      <div class="card stat">
        <div class="label">Head Tilts</div>
        <div id="tiltCount" class="value">0</div>
        <div class="small">Head-tilt events</div>
      </div>

      <div class="card stat">
        <div class="label">Total Alerts</div>
        <div id="totalCount" class="value">0</div>
        <div class="small">Sum of all tracked alerts</div>
      </div>

      <div class="card stat">
        <div class="label">Emails Sent</div>
        <div id="emailsSent" class="value">0</div>
        <div class="small">Notifications dispatched to contacts</div>
      </div>

      <div class="card stat">
        <div class="label">Last Update</div>
        <div id="lastUpdate" class="value">—</div>
        <div class="small">Auto refreshed every 2s</div>
      </div>
    </div>

    <div class="grid">
      <div class="card chart-card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
          <div style="font-weight:700">Alert breakdown</div>
          <div class="small">Live counts (bar chart)</div>
        </div>
        <div class="chart-wrap">
          <canvas id="alertsChart" style="width:100%;max-width:900px"></canvas>
        </div>
      </div>

      <div class="card right-panel">
        <div>
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
            <div style="font-weight:700">Recent Alerts</div>
            <div class="small badge" id="recentCount">0</div>
          </div>

          <div style="max-height:220px;overflow:auto">
            <table>
              <thead><tr><th>When</th><th>Type</th><th>Driver</th></tr></thead>
              <tbody id="recentBody">
                <tr><td colspan="3" class="placeholder">No recent alerts available</td></tr>
              </tbody>
            </table>
          </div>
        </div>

        <div style="margin-top:auto">
          <div style="font-size:13px;color:var(--muted);margin-bottom:10px"></div>
          <div style="font-size:13px;color:var(--muted)"></div>
        </div>
      </div>
    </div>
  </div>

<script>
  // Chart setup
  const ctx = document.getElementById('alertsChart').getContext('2d');
  const chart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: ['Sleep', 'Yawn', 'Head Tilt'],
      datasets: [{
        label: 'Alerts',
        data: [0,0,0],
        borderRadius: 8,
        borderSkipped: false,
        barPercentage: 0.6
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
        tooltip: { mode: 'index', intersect: false }
      },
      scales: {
        x: { grid: { display: false }, ticks: { color: '#cfe9f3' } },
        y: { beginAtZero: true, ticks: { color: '#cfe9f3' } }
      },
      animation: { duration: 700, easing: 'easeOutQuart' }
    }
  });

  // DOM refs
  const sleepCountEl = document.getElementById('sleepCount');
  const yawnCountEl  = document.getElementById('yawnCount');
  const tiltCountEl  = document.getElementById('tiltCount');
  const totalCountEl = document.getElementById('totalCount');
  const emailsSentEl = document.getElementById('emailsSent');
  const lastUpdateEl = document.getElementById('lastUpdate');
  const recentBody = document.getElementById('recentBody');
  const recentCount = document.getElementById('recentCount');
  const refreshBtn = document.getElementById('refreshBtn');

  // fetch and update
  async function fetchStats() {
    try {
      const [countsRes, emailsRes, recentRes] = await Promise.all([
        fetch('/get_alert_counts'),
        fetch('/get_total_notifications'),
        fetch('/get_recent_alerts')
      ]);
      const counts = await countsRes.json();
      const emails = await emailsRes.json().catch(()=>({emails_sent:0}));
      const recent = await recentRes.json().catch(()=>({alerts:[]}));

      const sleep = counts.sleep || 0;
      const yawn  = counts.yawn  || 0;
      const tilt  = counts.head_tilt || 0;
      const total = sleep + yawn + tilt;

      // update cards
      sleepCountEl.textContent = sleep;
      yawnCountEl.textContent  = yawn;
      tiltCountEl.textContent  = tilt;
      totalCountEl.textContent = total;
      emailsSentEl.textContent = emails.emails_sent ?? 0;
      lastUpdateEl.textContent = new Date().toLocaleTimeString();

      // update chart
      chart.data.datasets[0].data = [sleep,yawn,tilt];
      chart.update();

      // recent alerts table
      const alerts = recent.alerts || [];
      recentCount.textContent = alerts.length;
      if (alerts.length === 0) {
        recentBody.innerHTML = '<tr><td colspan="3" class="placeholder">No recent alerts available</td></tr>';
      } else {
        recentBody.innerHTML = alerts.map(a => {
          const t = new Date(a.timestamp || Date.now()).toLocaleString();
          const user = a.user || '—';
          const type = (a.type || '').toUpperCase();
          return `<tr><td>${t}</td><td>${type}</td><td>${user}</td></tr>`;
        }).join('');
      }
    } catch (err) {
      console.error("Dashboard fetch error", err);
    }
  }

  // poll regularly
  let pollInterval = setInterval(fetchStats, 2000);
  fetchStats(); // initial

  refreshBtn.addEventListener('click', fetchStats);
</script>
</body>
</html>
